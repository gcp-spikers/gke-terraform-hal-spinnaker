schema: "1"
id: cleanupCanary
metadata:
  description: Cleanup Canary and Baseline clusters
  name:  Cleanup Canary and Baseline clusters
  owner: pipelineservice@ea.anz.com
  scopes:
  - global
protect: false

variables:
- name: account
  type: String
- name: namespace
  type: String
- name: prodPipelineId
  type: String

configuration:
  concurrentExecutions:
    limitConcurrent: true
    parallel: true
  triggers:
  - type: pipeline
    enabled: true
    application: "{{ application }}"
    pipeline: "{{ prodPipelineId }}"
    status:
    - successful
    - failed
    - canceled

stages:
- id: destroyBaseline
  name: Destroy Baseline
  type: destroyServerGroup
  config:
    cluster: "{{ application }}-prod-baseline"
    credentials: "{{account}}"
    completeOtherBranchesThenFail: false
    continuePipeline: true
    failPipeline: false
    target: "current_asg_dynamic"
    cloudProvider: kubernetes
    cloudProviderType: kubernetes
    interestingHealthProviderNames:
    - KubernetesService
    namespaces:
    - "{{namespace}}"

- id: destroyCanary
  name: Destroy Canary
  type: destroyServerGroup
  config:
    cluster: "{{ application }}-prod-canary"
    credentials: "{{account}}"
    completeOtherBranchesThenFail: false
    continuePipeline: true
    failPipeline: false
    target: "current_asg_dynamic"
    cloudProvider: kubernetes
    cloudProviderType: kubernetes
    interestingHealthProviderNames:
    - KubernetesService
    namespaces:
    - "{{namespace}}"
